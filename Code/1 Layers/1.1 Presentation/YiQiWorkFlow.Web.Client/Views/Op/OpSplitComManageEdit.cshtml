@model YiQiWorkFlow.Domain.Op.OpSplitComManage
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>组合拆零管理编辑</title>
    <link type="text/css" rel="Stylesheet" href="/Styles/editPage.css" />
    <script type="text/javascript" src="/scripts/boot.js"></script>
    <script type="text/javascript" src="/Scripts/editPage.js"></script>
    <script type="text/javascript"> var pageTitle = "组合拆零管理"; var formChanged = false; var pageType = "Edit"; var createTime = "2014/2/15 19:58:54"; var id = "@Model.Id"; pageName = "OpSplitComManageEdit";var isNew=@Model.IsAdded.ToString().ToLower();var userId="@YiQiWorkFlow.Web.Client.Common.MyEnv.LoginUser.Id";  </script>
    <script type="text/javascript">
        function SaveData() {
            var form = new mini.Form("#formMain"); // default form
            var o = form.getData(true);

            var grid1 = mini.get("datagrid1");
            grid1.commitEdit();
            var detail = grid1.getChanges();
            //验证子表
            if (detail.length == 0) {
                alert("必须设置组合拆零管理_商品明细！");
                return false;
            }
            for (var i = 0; i < detail.length; i++) {
                if (detail[i].GoodsCode == undefined) {
                    alert("商品编码不能为空！");
                    return false;
                }
                
                if (detail[i].PurchaseQty == undefined || detail[i].PurchaseQty == 0) {
                    alert("处理数量不能为空或者0！");
                    return false;
                }
            }
            
            o["detail"] = mini.encode(detail);

            $.ajax({
                url: "/Op/SaveOpSplitComManage",
                type: 'post',
                data: o,
                cache: false,
                dataType: "json",
                success: function (r) {
                    if (r.IsSuccess == true) {
                        //location.href = "/Op/OpSplitComManageList";
                        try{ history.go(-1); } catch(e){}
                    } else {
                        $("#Tooltip_Critical_PcPurchaseManage .content").first().text(r.Message);
                        $("#Tooltip_Critical_PcPurchaseManage").show("fast");
                        form.unmask();
                        $(document).scrollTop(0);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $("#Tooltip_Critical_PcPurchaseManage .content").first().text(jqXHR.responseText);
                    $("#Tooltip_Critical_PcPurchaseManage").show("fast");
                    form.unmask();
                    $(document).scrollTop(0);
                }
            });
        }

        function onGoodsChanged(e) {
            mini.getbyName("GoodsBarCode","datagrid1").setValue(e.selected.GoodsBarCode);
            mini.getbyName("Specification","datagrid1").setValue(e.selected.Specification);
            mini.getbyName("GoodsName","datagrid1").setValue(e.selected.GoodsName);
            mini.getbyName("PackUnitCode","datagrid1").setValue(e.selected.PackUnitCode);
            mini.getbyName("PurchasePrice","datagrid1").setValue(e.selected.PurchasePrice);
            mini.getbyName("NontaxPurchasePrice","datagrid1").setValue(e.selected.NontaxPurchasePrice);
            mini.getbyName("SalePrice","datagrid1").setValue(e.selected.SalePrice);
        }
        function cacMoney() {
            var count = parseInt(mini.getbyName("PurchaseQty", "datagrid1").getValue());
            var SalePrice = parseFloat(mini.getbyName("SalePrice", "datagrid1").getValue());
            var noTaxPrice = parseFloat(mini.getbyName("NontaxPurchasePrice", "datagrid1").getValue());
            var PurchasePrice=parseFloat(mini.getbyName("PurchasePrice", "datagrid1").getValue());

            mini.getbyName("SaleMoney", "datagrid1").setValue(count * SalePrice);
            mini.getbyName("NontaxSaleMoney", "datagrid1").setValue(count * noTaxPrice);
        }
        function cacMainMoney(){
            var count=mini.get("Control_PurchaseQty").getValue();
            var salePrice=mini.get("Control_SalePrice").getValue();

            mini.get("Control_SaleMoney").setValue(count*salePrice);
            mini.get("Control_PurchaseMoney").setValue(count*purchasePrice);
            mini.get("Control_NontaxPurchaseMoney").setValue(count*notaxPurchasePrice);
            mini.get("Control_NontaxSaleMoney").setValue(count*notaxPurchasePrice);
        }
        var purchasePrice=0;
        var notaxPurchasePrice=0;
        function onMainGoodsChanged(e){
            mini.get("Control_SalePrice").setValue(e.selected.SalePrice);
            purchasePrice=e.selected.purchasePrice;
            notaxPurchasePrice=e.selected.NontaxPurchasePrice;
            cacMainMoney();
        }
        function addRow(row) {
            var grid = mini.get("datagrid1");
            grid.addRow(row, 0);

        }
        function onrowdblclick(e) {
            var grid = mini.get("datagrid1");
            if (grid.isEditing()) {
                grid.commitEdit();
            }
            grid.beginEditRow(e.row);
            setTimeout(function () {
                //    mini.getbyName("GoodsCode", "datagrid1").focus();
            }, 500);

        }
        function ExameData() {
            var chk = mini.get("Control_IfExamine");
            chk.setValue("1");
            mini.get("Control_ExamineDate").setValue(new Date());
            mini.get("Control_Assessor").setValue(userId);
            clearExameAfterSave = false;
            if (isNew == false) {
                //立即生效
                $.getJSON("/Common/ChangeDbValue?table=op_split_com_manage&pkColumn=sc_number&pk=@Model.Id&assessor=&if_examine=1&examine_date=" + (new Date()).format("yyyy-MM-dd"), function (r) {
                    location.href = "/Op/OpSplitComManageList";
            });
        }
        $("#btnExame").prop("disabled", true);
    }
    $(function () {
        var grid = mini.get("datagrid1");
        grid.reload();
        jQuery.hotkeys.add('return', function () {
            //if (mini.get("filter_SupCode").getValue().length == 0) {
            //    alert("必须选择供货商");
            //    return false;
            //}
            if (grid.isEditing()) {
                grid.commitEdit();
            }
            var row = {};
            grid.addRow(row, 0);
            grid.cancelEdit();
            grid.beginEditRow(row);
            //mini.getbyName("GoodsCode", "datagrid1").setUrl("/Fb/SearchFbGoodsArchivesListForList?SupCode=" + mini.get("filter_SupCode").getValue());
            setTimeout(function () {
                //    mini.getbyName("GoodsCode", "datagrid1").focus();
            }, 500);
        });
        jQuery.hotkeys.add('esc', function () {
            grid.reload();
        });
        jQuery.hotkeys.add('del', function () {
            grid.removeRows(grid.getSelecteds());
        });

        //$("#btnExame").click(function () {
        //    var chk = mini.get("Control_IfExamine");
        //    chk.setValue("1");
        //    mini.get("Control_ExamineDate").setValue(new Date());
        //    clearExameAfterSave = false;
        //    if (isNew == false) {
        //       //立即生效
        //        $.getJSON("/Common/ChangeDbValue?table=op_split_com_manage&pkColumn=sc_number&pkValue=@Model.Id&assessor=&if_examine=1&examine_date=" + new Date(), function (r) {
            //
            //        });
            //    }
            //    $("#btnExame").prop("disabled", true);
            //});
            if ("@Model.IfExamine" == "1") {
                $("#btnExame").prop("disabled", true);
            }
            $("#btnInStock").click(function () {
                mini.get("Control_IfPutin").setValue("1");
                mini.get("Control_PutinDate").setValue(new Date());
            });
            $("#btnDel").click(function () {
                if (isNew == false) {
                    //删除
                    $.ajax({
                        url: "/Op/OpSplitComManageDelete",
                        data: { ids: id, confirm: "true" },
                        dataType: "json",
                        success: function (r) {
                            closeWithNoValidate();
                        }
                    });
                }
                else {
                    closeWithNoValidate();
                }
            });
            $("#btnGoods").click(function () {
                var btnEdit = this;
                //if (mini.get("filter_SupCode").getValue().length == 0) {
                //    alert("必须选择供货商");
                //    return false;
                //}
                mini.open({
                    url: "/Common/GoodsSelector?OpCode=3",
                    title: "选择商品",
                    width: 600,
                    height: 380,
                    ondestroy: function (action) {
                        //if (action == "close") return false;
                        if (action == "ok") {
                            var iframe = this.getIFrameEl();
                            var data = iframe.contentWindow.GetData();
                            data = mini.clone(data);    //
                            if (data) {
                                for (var i = 0; i < data.length; i++) {
                                    var row = {
                                        GoodsCode: data[i].Id,
                                        GoodsBarCode: data[i].GoodsBarCode,
                                        Specification: data[i].Specification,
                                        PackUnitCode: data[i].PackUnitCode,
                                        OfferMin: data[i].OfferMin,
                                        StockQty: data[i].StockQty,
                                        OrderQty: data[i].OrderQty,
                                        PackQty: data[i].PackQty,
                                        PackCoef: data[i].PackCoef,
                                        PurchaseQty: data[i].PurchaseQty,
                                        PutinQty: data[i].PutinQty,
                                        SalePrice: data[i].SalePrice,
                                        PurchasePrice: data[i].PurchasePrice,
                                        NontaxPurchasePrice: data[i].NontaxPurchasePrice,
                                        PurchaseMoney: data[i].PurchaseMoney,
                                        NontaxPurchaseMoney: data[i].NontaxPurchaseMoney,
                                        ProduceDate: data[i].ProduceDate
                                    };
                                    addRow(row);
                                }
                            }
                        }

                    }
                });
            });
            $("#btnQuery").click(function () {
                location.href = "/Op/OpSplitComManageList";
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <div id="toolbar1" class="mini-toolbar" style="padding: 2px;">
            <table style="width: 100%;">
                <tr>
                    <td>
                        <a id="btnFormSubmit" iconcls="icon-save" class="mini-button" plain="true" tooltip="保存(Ctrl+S)">保存</a>
                        <a id="btnGoods" iconcls="icon-find" class="mini-button" plain="true" tooltip="商品">商品</a>
                        <a id="btnExame" iconcls="icon-ok" class="mini-button" plain="true" tooltip="审核(Ctrl+E)">审核</a>
                        <a id="btnQuery" iconcls="icon-search" class="mini-button" plain="true" tooltip="查询">查询</a>
                        <a id="btnSubmit" iconcls="icon-upgrade" class="mini-button" plain="true" tooltip="提交">提交</a>
                        <a id="btnPrint" iconcls="icon-printer" class="mini-button" plain="true" tooltip="打印">打印</a>
                        <a id="btnFormReset" iconcls="icon-undo" class="mini-button" plain="true" tooltip="重置(Esc)">重置</a>
                        <a id="btnClosePage" iconcls="icon-no" class="mini-button" plain="true" tooltip="关闭(Ctrl+Q)">关闭</a>
                    </td>
                    <td>
                    </td>
                </tr>
            </table>
        </div>
        <form id="formMain" method="post" action="">
            <fieldset>
                <legend>组合拆零管理编辑</legend>
            	<div class="ablock">
                <label for="Control_ScNumber">处理单号:</label>
                <input id="Control_ScNumber" value="@Model.Id" name="Id" class="mini-textbox" enabled="false"/>
            </div>

            	<div class="ablock">
                <label for="Control_ScDate">处理日期:</label>
                <input type="text" id="Control_ScDate" name="ScDate"  value="@Model.ScDate" class="mini-datepicker"  format="yyyy-MM-dd H:mm:ss" timeFormat="H:mm:ss" showTime="true" showOkButton="true" showClearButton="true" required="false" />
            </div>

            	<div class="ablock">
                <label for="Control_ScType">处理方式:</label>
                <input type="text"  value="@Model.ScType" class="mini-textbox" name="ScType" id="Control_ScType" vtype="maxLength:20" />
            </div>

            	<div class="ablock">
                <label for="Control_WhCode">仓库编码:</label>
                <input type="text"  value="@Model.WhCode" class="mini-textbox" name="WhCode" id="Control_WhCode" vtype="maxLength:20" />
            </div>

            	<div class="ablock">
                <label for="Control_GoodsCode">商品编码:</label>
                    <div id="Control_GoodsCode" popupwidth="400" value="@Model.GoodsCode" name="GoodsCode" property="editor" class="mini-combobox" allowinput="true" valuefield="Id" textfield="Id" onvaluechanged="onMainGoodsChanged" url="/Fb/SearchFbGoodsArchivesListForList" style="width: 100%;">
                        <div property="columns">                            
                            <div header="销售码" field="GoodsBarCode">
                            </div>
                            <div header="拼音码" field="PyCode">
                            </div>
                            <div header="商品名称" field="GoodsName">
                            </div>
                        </div>
                    </div>
            </div>

            	<div class="ablock">
                <label for="Control_PurchaseQty">处理数量:</label>
                <input type="text" id="Control_PurchaseQty" name="PurchaseQty"  value="@Model.PurchaseQty" class="mini-spinner" minValue="0" maxValue="999999" decimalPlaces="2" onvaluechanged="cacMainMoney"/>
            </div>

            	<div class="ablock">
                <label for="Control_PurchaseMoney">含税金额:</label>
                <input type="text" id="Control_PurchaseMoney" name="PurchaseMoney"  value="@Model.PurchaseMoney" class="mini-spinner" minValue="0" maxValue="999999" decimalPlaces="6" enabled="false"/>
            </div>

            	<div class="ablock">
                <label for="Control_NontaxPurchaseMoney">不含税金额:</label>
                <input type="text" id="Control_NontaxPurchaseMoney" name="NontaxPurchaseMoney"  value="@Model.NontaxPurchaseMoney" class="mini-spinner" minValue="0" maxValue="999999" decimalPlaces="6" enabled="false"/>
            </div>

            	<div class="ablock">
                <label for="Control_SalePrice">销售价:</label>
                <input type="text" id="Control_SalePrice" name="SalePrice"  value="@Model.SalePrice" class="mini-spinner" minValue="0" maxValue="999999" decimalPlaces="4" enabled="false"/>
            </div>

            	<div class="ablock">
                <label for="Control_SaleMoney">售价金额:</label>
                <input type="text" id="Control_SaleMoney" name="SaleMoney"  value="@Model.SaleMoney" class="mini-spinner" minValue="0" maxValue="999999" decimalPlaces="4" enabled="false"/>
            </div>

            	<div class="ablock">
                <label for="Control_NontaxSaleMoney">不含税售价金额:</label>
                <input type="text" id="Control_NontaxSaleMoney" name="NontaxSaleMoney"  value="@Model.NontaxSaleMoney" class="mini-spinner" minValue="0" maxValue="999999" decimalPlaces="4" enabled="false"/>
            </div>

            	<div class="ablock">
                <label for="Control_CreateDate">创建时间:</label>
                <input type="text" id="Control_CreateDate" name="CreateDate"  value="@Model.CreateDate" class="mini-datepicker"  format="yyyy-MM-dd H:mm:ss" timeFormat="H:mm:ss" showTime="true" showOkButton="true" showClearButton="true" required="false" />
            </div>

            	<div class="ablock">
                <label for="Control_Operator">操作员:</label>
                <input type="text"  value="@Model.Operator" class="mini-textbox" name="Operator" id="Control_Operator" vtype="maxLength:20" />
            </div>

            	<div class="ablock">
                <label for="Control_Assessor">审核人:</label>
                <input type="text"  value="@Model.Assessor" class="mini-textbox" name="Assessor" id="Control_Assessor" vtype="maxLength:20" />
            </div>

            	<div class="ablock">
                <label for="Control_IfExamine">是否审核:</label>
                <div id="Control_IfExamine" name="IfExamine" value="@Model.IfExamine" class="mini-checkbox" trueValue="1" falseValue="0" readOnly="false" text="审核"></div>
            </div>

            	<div class="ablock">
                <label for="Control_ExamineDate">审核时间:</label>
                <input type="text" id="Control_ExamineDate" name="ExamineDate"  value="@Model.ExamineDate" class="mini-datepicker"  format="yyyy-MM-dd H:mm:ss" timeFormat="H:mm:ss" showTime="true" showOkButton="true" showClearButton="true" required="false" />
            </div>

            	<div class="ablock">
                <label for="Control_OperatorDate">操作时间:</label>
                <input type="text" id="Control_OperatorDate" name="OperatorDate"  value="@Model.OperatorDate" class="mini-datepicker"  format="yyyy-MM-dd H:mm:ss" timeFormat="H:mm:ss" showTime="true" showOkButton="true" showClearButton="true" required="false" />
            </div>

            </fieldset>

            <div id="datagrid1" class="mini-datagrid" url="/Op/SearchOpSplitComDetailList?ScNumber=@(string.IsNullOrEmpty(Model.Id) ? "!##$%" : Model.Id)"
                style="width: 100%; height: 250px; margin-top:10px;" idfield="id" allowresize="false" sizelist="[20,30,50,100]"
                pagesize="20" multiselect="true" showfilterrow="false" showPager="false" onrowdblclick="onrowdblclick"
                allowAlternating="true"  emptyText="数据为空，<a href='javascript:_newRow(&quot;datagrid1&quot;)'>增加一条</a>" showEmptyText="true">
                <div property="columns">
                    <div type="indexcolumn" width="30">
                    </div>
                    <div type="checkcolumn" width="30">
                    </div>
                    <div renderer="_onActionRenderer" headeralign="center" align="center" width="70">管理</div>
					<div field="GoodsCode" headeralign="center" align="center" width="60">
					    商品编码
					<div id="editor_GoodsCode" popupwidth="400" name="GoodsCode" property="editor" class="mini-combobox" allowinput="true" valuefield="Id" textfield="Id" onvaluechanged="onGoodsChanged" url="/Fb/SearchFbGoodsArchivesListForList" style="width: 100%;"  onvaluechanged="cacMainMoney">
                        <div property="columns">                            
<div header="销售码" field="GoodsBarCode">
                            </div>
                            <div header="拼音码" field="PyCode">
                            </div>
                            <div header="商品名称" field="GoodsName">
                            </div>
                        </div>
                    </div>

					</div>
                    <div field="GoodsName" headeralign="center" align="center" width="60">
					    商品名称
					<input id="editor_GoodsBarCode" name="GoodsName" property="editor" class="mini-textbox" style="width:100%;" enabled="false" />
					</div>

					<div field="GoodsBarCode" headeralign="center" align="center" width="60">
					    商品销售码
					<input id="editor_GoodsBarCode" name="GoodsBarCode" property="editor" class="mini-textbox" style="width:100%;" enabled="false" />
					</div>


					<div field="Specification" headeralign="center" align="center" width="60">
					    规格
					<input id="editor_Specification" name="Specification" property="editor" class="mini-textbox" style="width:100%;" enabled="false" />
					</div>


					<div field="PackUnitCode" headeralign="center" align="center" width="60">
					    包装单位
					<input id="editor_PackUnitCode" name="PackUnitCode" property="editor" class="mini-textbox" style="width:100%;" enabled="false" />
					</div>


					<div field="PurchaseQty" headeralign="center" align="center" width="60" onvaluechanged="cacMainMoney">
					    处理数量
<input type="text" id="editor_PurchaseQty" name="PurchaseQty" property="editor"  class="mini-spinner" minValue="0" maxValue="1000" decimalPlaces="4" style="width: 100%;" onvaluechanged="cacMoney"/>
					</div>


					<div field="PurchasePrice" headeralign="center" align="center" width="60">
					    含税进价
<input type="text" id="editor_PurchasePrice" name="PurchasePrice" property="editor"  class="mini-spinner" minValue="0" maxValue="1000" decimalPlaces="6" style="width: 100%;" enabled="false"/>
					</div>


					<div field="NontaxPurchasePrice" headeralign="center" align="center" width="60">
					    不含税进价
<input type="text" id="editor_NontaxPurchasePrice" name="NontaxPurchasePrice" property="editor"  class="mini-spinner" minValue="0" maxValue="1000" decimalPlaces="6" style="width: 100%;" enabled="false"/>
					</div>


					<div field="PurchaseMoney" headeralign="center" align="center" width="60">
					    含税金额
<input type="text" id="editor_PurchaseMoney" name="PurchaseMoney" property="editor"  class="mini-spinner" minValue="0" maxValue="1000" decimalPlaces="6" style="width: 100%;" enabled="false"/>
					</div>


					<div field="NontaxPurchaseMoney" headeralign="center" align="center" width="60">
					    不含税金额
<input type="text" id="editor_NontaxPurchaseMoney" name="NontaxPurchaseMoney" property="editor"  class="mini-spinner" minValue="0" maxValue="1000" decimalPlaces="6" style="width: 100%;" enabled="false"/>
					</div>


					<div field="SalePrice" headeralign="center" align="center" width="60">
					    销售价
<input type="text" id="editor_SalePrice" name="SalePrice" property="editor"  class="mini-spinner" minValue="0" maxValue="1000" decimalPlaces="4" style="width: 100%;" enabled="false"/>
					</div>


					<div field="SaleMoney" headeralign="center" align="center" width="60">
					    售价金额
<input type="text" id="editor_SaleMoney" name="SaleMoney" property="editor"  class="mini-spinner" minValue="0" maxValue="1000" decimalPlaces="4" style="width: 100%;" enabled="false"/>
					</div>


					<div field="NontaxSaleMoney" headeralign="center" align="center" width="60">
					    不含税售价金额
<input type="text" id="editor_NontaxSaleMoney" name="NontaxSaleMoney" property="editor"  class="mini-spinner" minValue="0" maxValue="1000" decimalPlaces="4" style="width: 100%;" enabled="false"/>
					</div>

                </div>
            </div>

            <div class="clear">
            </div>
            @*<div class="control-panel">
                <div class="control-button">
                    <input type="button" class="myButton" id="btnFormSubmit" value="保存(Ctrl+S)" />
                    <input type="button" class="myButton" id="btnGoods" value="商品" />
                    <input type="button" class="myButton" id="btnInStock" value="入库" />
                    <input type="button" class="myButton" id="btnExame" value="审核(Ctrl+E)" />
                    <input type="button" class="myButton" id="btnQuery" value="查询" />
                    <input type="button" class="myButton" id="btnSubmit" value="提交" />
                    <input type="button" class="myButton" id="btnPrint" value="打印" />
                    <input type="reset" class="myGrayButton" id="btnFormReset" value="重置(Esc)" />
                    <input type="button" class="myRedButton" id="btnClosePage" value="关闭(Ctrl+Q)" />
                </div>
                <div class="botton-up">
                </div>
            </div>
			*@
        </form>
    </div>
</body>
</html>
<!--
ScNumber:j.data[i].ScNumber,
GoodsCode:j.data[i].GoodsCode,
GoodsBarCode:j.data[i].GoodsBarCode,
Specification:j.data[i].Specification,
PackUnitCode:j.data[i].PackUnitCode,
PurchaseQty:j.data[i].PurchaseQty,
PurchasePrice:j.data[i].PurchasePrice,
NontaxPurchasePrice:j.data[i].NontaxPurchasePrice,
PurchaseMoney:j.data[i].PurchaseMoney,
NontaxPurchaseMoney:j.data[i].NontaxPurchaseMoney,
SalePrice:j.data[i].SalePrice,
SaleMoney:j.data[i].SaleMoney,
NontaxSaleMoney:j.data[i].NontaxSaleMoney,
Id:j.data[i].Id,
-->
